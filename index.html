<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DJ's Retirement Fund Loan Payoff Calculator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #3498db;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-top: 0;
            font-size: 1.5em;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #34495e;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .loan-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .loan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .slider-container {
            margin: 20px 0;
        }
        
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: none;
        }
        
        .slider:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .slider:disabled::-webkit-slider-thumb {
            cursor: not-allowed;
            background: #bdc3c7;
        }
        
        .slider:disabled::-moz-range-thumb {
            cursor: not-allowed;
            background: #bdc3c7;
        }
        
        .results {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .results h2 {
            margin-top: 0;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
        }
        
        .metric-value {
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        .tax-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            color: #333;
        }
        
        .warning {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .loan-breakdown-wrapper {background: rgba(255,255,255,0.08); padding:15px; border-radius:8px; margin-top:10px;}
        .loan-breakdown-item {margin:6px 0;}
        .loan-breakdown-item details {background: rgba(0,0,0,0.15); padding:8px 10px; border-radius:6px;}
        .loan-breakdown-item details[open] {background: rgba(0,0,0,0.25);}        
        .loan-breakdown-grid {display:grid; grid-template-columns: repeat(auto-fit,minmax(170px,1fr)); gap:6px 12px; margin-top:10px; font-size:0.85em;}
        .loan-breakdown-grid div {display:flex; justify-content:space-between; background: rgba(255,255,255,0.08); padding:4px 6px; border-radius:4px;}
        .loan-breakdown-grid span.highlight {font-weight:600; color:#ffe28a;}
        .loan-breakdown-help {font-size:0.75em; opacity:0.8; margin-bottom:6px;}
        .warning-item {color:#ffb3b3; font-size:0.85em;}
        /* New utility / refactor classes */
        .panel-note {font-size:0.75em; opacity:.8; display:block; margin-top:6px;}
        .deduction-panel {grid-column:1 / -1; background:#eef3ff; padding:12px; border-radius:6px; border-left:4px solid #4b7bd8;}
        .deduction-flex {display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end;}
        .flex-1 {flex:1; min-width:180px;}
        .flex-1-wide {flex:1; min-width:200px;}
        .flex-1-mid {flex:1; min-width:190px;}
        .no-bold {font-weight:400;}
        .mr-6 {margin-right:6px;}
        .mt-5 {margin-top:5px;}
        .mt-10 {margin-top:10px;}
        .mt-15 {margin-top:15px;}
        .penalty-box {margin-top:5px; background:#f4f0ff; padding:10px; border-radius:6px; border-left:4px solid #8e44ad;}
        .penalty-box small {color:#555;}
        .inline-flex {display:flex; align-items:center; gap:8px; cursor:pointer;}
        .roth-box {background:#e8f5e8; padding:15px; border-radius:8px; border-left:4px solid #27ae60;}
        .roth-note {color:#666; display:block; margin-top:5px;}
        .hidden {display:none !important;}
        .flex-between {display:flex; align-items:center; justify-content:space-between; gap:12px;}
        .btn-compact {padding:6px 14px; font-size:0.8em;}
        .impact-immediate {background: rgba(155, 89, 182, 0.3); border-left:4px solid #9b59b6;}
        .impact-penalty {background: rgba(142,68,173,0.25); border-left:4px solid #8e44ad;}
        .impact-roth {background: rgba(39, 174, 96, 0.2); border-left:4px solid #27ae60;}
        .tax-rate-wrapper {margin-top:16px;}
        .assumptions-block {margin-top:10px; background:rgba(255,255,255,0.12); padding:12px; border-radius:6px;}
        .assumptions-block ul {margin:8px 0 0 18px;}
        .assumptions-block li {margin:4px 0;}
        .header-links {display:flex; justify-content:flex-end; gap:12px; margin-bottom:10px;}
        .link-docs {color:#3498db; font-weight:600; text-decoration:none;}
        .link-docs:hover {text-decoration:underline;}
        .footer {text-align:center; margin-top:18px; font-size:0.9em; opacity:0.9;}
        .footer a {color:#3498db; text-decoration:none;}
        .footer a:hover {text-decoration:underline;}
        .summary-strong {cursor:pointer; font-weight:600;}
        .results-divider {border-color: rgba(255,255,255,0.3);}
        .m-0 {margin:0;}
        .assumptions-note {margin-top:6px; font-size:0.85em; opacity:0.85;}
        .calc-explanation {background: rgba(255,255,255,0.15); margin:8px 0; padding:12px; border-radius:6px; font-size:0.9em; line-height:1.4; border-left:3px solid rgba(255,255,255,0.4); display:none;}
        .calc-explanation.show {display:block;}
        .calc-link {cursor:pointer; text-decoration:underline; opacity:0.9;}
        .calc-link:hover {opacity:1; color:#FFE5B4;}
        .filing-status-note {font-weight: normal; color: #666;}
    </style>
</head>
<body>
    <div class="container">
        <h1>💰 Retirement Fund Loan Payoff Calculator</h1>
        <div class="header-links">
            <a class="link-docs" href="docs.html" target="_blank" rel="noopener">📚 Documentation</a>
            <a class="link-docs" href="quick-start.html" target="_blank" rel="noopener">🚀 Quick Start</a>
            <a class="link-docs" href="#" onclick="resetApp(); return false;">Reset</a>
            <a class="link-docs" href="#" onclick="loadSampleData(); return false;">Sample Data</a>
            <a class="link-docs" href="#" onclick="saveScenario(); return false;">Save Scenario</a>
        </div>
        
        <div id="scenario-loader" class="form-group hidden" style="margin-bottom: 20px;">
            <label for="scenarioSelect">Load Saved Scenario</label>
            <select id="scenarioSelect">
                <option value="">-- Select a Scenario --</option>
            </select>
        </div>

        <div class="warning">
            <strong>Disclaimer:</strong> This calculator is for educational purposes only. Consult with a financial advisor before making major financial decisions.
        </div>

        <div class="section" id="incomeTaxSection">
            <h2>💼 Income & Tax Inputs</h2>
            <div class="form-group">
                <label for="taxableIncome">Annual Gross Income ($)</label>
                <input type="number" id="taxableIncome" min="0">
            </div>
            <div class="form-group">
                <label for="accountType">Retirement Account Type</label>
                <select id="accountType">
                    <option value="traditional">Traditional 401(k)/403(b) (Pre-tax)</option>
                    <option value="roth">Roth IRA (After-tax)</option>
                </select>
                <small class="panel-note">Traditional accounts are taxed on withdrawal; Roth contributions can be withdrawn tax-free and penalty-free at any time.</small>
            </div>
            <div class="form-group" id="filingStatusGroup">
                <label for="filingStatus">Filing Status <span id="filingStatusNote" class="hidden filing-status-note">(less critical for Roth)</span></label>
                <select id="filingStatus">
                    <option value="single">Single</option>
                    <option value="marriedJoint">Married Filing Jointly</option>
                    <option value="headOfHousehold">Head of Household</option>
                    <option value="marriedSeparate">Married Filing Separately</option>
                </select>
            </div>
            <div class="form-group">
                <label for="retirementBalance">Available for Withdrawal ($)</label>
                <input type="number" id="retirementBalance" min="0">
            </div>
            <div class="form-group">
                <label for="expectedReturn">Expected Annual Return on Retirement Account (%)</label>
                <input type="number" id="expectedReturn" min="0" max="20" step="0.1">
            </div>
            <div class="form-group">
                <label for="projectionYears">Projection Time Horizon (Years)</label>
                <select id="projectionYears">
                    <option value="5">5 Years</option>
                    <option value="10" selected>10 Years</option>
                    <option value="15">15 Years</option>
                    <option value="20">20 Years</option>
                    <option value="25">25 Years</option>
                    <option value="30">30 Years</option>
                </select>
            </div>
            <div class="form-group">
                <label for="stateTaxRate">State Income Tax Rate (%) <span title="Flat estimate applied to full withdrawal for simplicity">ℹ️</span></label>
                <input type="number" id="stateTaxRate" min="0" max="20" step="0.1">
            </div>
            <div class="form-group deduction-panel">
                <label class="mb-8">Deduction Options</label>
                <div class="deduction-flex">
                    <label class="flex-1 no-bold"> 
                        <input type="checkbox" id="applyStandardDeduction" checked class="mr-6"> Apply Standard Deduction
                    </label>
                    <div class="flex-1-wide">
                        <label for="itemizedDeduction" class="no-bold">Itemized Deduction ($) <small>(overrides standard if > 0)</small></label>
                        <input type="number" id="itemizedDeduction" min="0">
                    </div>
                    <div class="flex-1-mid">
                        <label for="age65Addl" class="no-bold">Age 65+? (Adjust) <span title="Adjusts only the standard deduction amount.">ℹ️</span></label>
                        <select id="age65Addl">
                            <option value="none" selected>No</option>
                            <option value="primary">Primary Taxpayer 65+</option>
                            <option value="both">Both 65+ (MFJ)</option>
                        </select>
                    </div>
                </div>
                <small class="panel-note">Tool will compute taxable income from gross using deduction rules; un-checking treats the income figure as already taxable. Age 65+ here only adjusts the standard deduction; it does not affect the 10% early withdrawal penalty (use the separate penalty toggle for being under age 59½). 
                    <a href="standard-deduction.html" target="_blank" rel="noopener">Docs: Standard Deduction</a>
                </small>
            </div>
        </div>
        
        <!-- Market Outlook Section -->
        <div class="section">
            <h2>📈 Market Outlook (Optional)</h2>
            <div class="form-group">
                <label class="inline-flex">
                    <input type="checkbox" id="marketTimingEnabled" class="mr-6">
                    <strong>Factor in potential market correction</strong>
                </label>
                <small class="panel-note">If you believe the market is overvalued and due for a correction, this adjusts the foregone growth calculation to reflect potential downside risk.</small>
            </div>
            <div id="marketTimingOptions" class="hidden">
                <div class="grid">
                    <div class="form-group">
                        <label for="marketCorrectionPct">Expected Market Correction (%)</label>
                        <input type="number" id="marketCorrectionPct" min="0" max="80" step="1" value="30">
                        <small class="panel-note">How much do you expect the market to drop? (e.g., 30% for a significant correction)</small>
                    </div>
                    <div class="form-group">
                        <label for="recoveryTimeYears">Recovery Time (Years)</label>
                        <input type="number" id="recoveryTimeYears" min="0.5" max="10" step="0.5" value="3">
                        <small class="panel-note">How long until the market recovers to pre-correction levels?</small>
                    </div>
                </div>
                <div class="tax-info">
                    <strong>Market Timing Logic:</strong> If a correction occurs early in the projection period, your withdrawn funds avoid the loss but also miss the recovery growth. This calculation models both the downside protection and opportunity cost.
                </div>
            </div>
        </div>
        
        <!-- Loans Section -->
        <div class="section">
            <h2>🏦 Current Loans</h2>
            <button class="btn btn-primary" onclick="addLoan()">+ Add Loan</button>
            <div id="loansList"></div>
        </div>
        
        <!-- Calculator Section -->
    <div class="section hidden" id="calculatorSection">
            <h2>🎯 Payoff Strategy</h2>
            <div class="form-group">
                <label for="withdrawalSlider">Retirement Withdrawal Amount: $<span id="withdrawalAmount">0</span></label>
                <input type="range" id="withdrawalSlider" class="slider" min="0" max="100000" value="0" step="100">
            </div>
            <div class="form-group">
                <label class="inline-flex">
                    <input type="checkbox" id="autoWithdrawCheck" class="mr-6">
                    <strong>Only withdraw what's needed for selected paydowns</strong>
                </label>
                <small class="roth-note" id="autoWithdrawNote">Automatically sizes the withdrawal to cover loan allocations after tax and penalties. Prevents oversized withdrawals and inflated foregone-growth penalties.</small>
            </div>
            <div class="form-group penalty-box" id="earlyPenaltyContainer">
                <label class="inline-flex">
                    <input type="checkbox" id="earlyPenaltyCheck"> <strong id="penaltyLabel">Apply 10% Early Withdrawal Penalty (Under age 59½)</strong> <span title="If you are 59½ or older, leave this off.">ℹ️</span>
                </label>
                <small id="penaltyDescription">Adds a 10% penalty on the withdrawal (in addition to income tax) and reduces after-tax cash available.</small>
            </div>
            
            <div id="loanSliders"></div>
            
            <div class="form-group">
                <label>Remaining Cash: $<span id="remainingCash">0</span></label>
            </div>
            
            <div class="form-group roth-box">
                <label>
                    <input type="checkbox" id="rothRedirectCheck" class="mr-6">
                    <strong>Redirect freed loan payments to Roth IRA?</strong>
                </label>
                <div id="rothRedirectOptions" class="hidden mt-15">
                    <label>Monthly amount to redirect to Roth IRA: $<span id="rothRedirectAmount">0</span> (<span id="rothRedirectPercent">0</span>% of loan payments)</label>
                    <input type="range" id="rothRedirectSlider" class="slider" min="0" max="1000" value="0" step="10">
                    <div class="mt-10">
                        <label class="inline-flex">
                            <input type="checkbox" id="rothMaxRedirect" class="mr-6">
                            <strong>Redirect 100% of freed payments</strong>
                        </label>
                        <small class="roth-note">Automatically sets slider to maximum available freed payments. Uncheck to manually set amount.</small>
                    </div>
                    <div class="mt-10">
                        <label class="inline-flex">
                            <input type="checkbox" id="rothTermRemaining" class="mr-6">
                            <strong>Only redirect for remaining loan term</strong>
                        </label>
                        <small class="roth-note">Contributions stop when the originally scheduled payments would have ended, then continue compounding until the projection horizon.</small>
                    </div>
                    <small class="roth-note">
                        <em>Note: This calculates the future value of redirecting loan payments into a Roth IRA with the same expected return.</em>
                    </small>
                </div>
            </div>
        </div>
        
        <!-- Results Section -->
    <div id="results" class="results hidden">
        <h2 class="flex-between">📈 Financial Impact Analysis <button class="btn btn-success btn-compact" id="exportCsvBtn">Export CSV</button></h2>
            <div id="resultsContent"></div>
        </div>
        <div class="footer">
            <a href="docs.html" target="_blank" rel="noopener">📚 Documentation Hub</a> | 
            <a href="quick-start.html" target="_blank" rel="noopener">🚀 Quick Start Guide</a>
        </div>
    </div>

    <script>
        let lastLoanBreakdownRows = [];
        // 2024 Tax Brackets
        const taxBrackets = {
            single: [
                { min: 0, max: 11600, rate: 0.10 },
                { min: 11601, max: 47150, rate: 0.12 },
                { min: 47151, max: 100525, rate: 0.22 },
                { min: 100526, max: 191950, rate: 0.24 },
                { min: 191951, max: 243725, rate: 0.32 },
                { min: 243726, max: 609350, rate: 0.35 },
                { min: 609351, max: Infinity, rate: 0.37 }
            ],
            marriedJoint: [
                { min: 0, max: 23200, rate: 0.10 },
                { min: 23201, max: 94300, rate: 0.12 },
                { min: 94301, max: 201050, rate: 0.22 },
                { min: 201051, max: 383900, rate: 0.24 },
                { min: 383901, max: 487450, rate: 0.32 },
                { min: 487451, max: 731200, rate: 0.35 },
                { min: 731201, max: Infinity, rate: 0.37 }
            ],
            headOfHousehold: [
                { min: 0, max: 16550, rate: 0.10 },
                { min: 16551, max: 63100, rate: 0.12 },
                { min: 63101, max: 100500, rate: 0.22 },
                { min: 100501, max: 191950, rate: 0.24 },
                { min: 191951, max: 243700, rate: 0.32 },
                { min: 243701, max: 609350, rate: 0.35 },
                { min: 609351, max: Infinity, rate: 0.37 }
            ],
            marriedSeparate: [
                { min: 0, max: 11600, rate: 0.10 },
                { min: 11601, max: 47150, rate: 0.12 },
                { min: 47151, max: 100525, rate: 0.22 },
                { min: 100526, max: 191950, rate: 0.24 },
                { min: 191951, max: 243725, rate: 0.32 },
                { min: 243726, max: 365600, rate: 0.35 },
                { min: 365601, max: Infinity, rate: 0.37 }
            ]
        };
        
        let loans = [];
        let loanCounter = 0;
        let currentScenarioName = null; // Track currently loaded scenario
        
        function addLoan(preventFocus = false) {
            const loanId = 'loan_' + loanCounter++;
            const loanDiv = document.createElement('div');
            loanDiv.className = 'loan-item';
            loanDiv.innerHTML = `
                <div class="loan-header">
                    <h3>Loan ${loanCounter}</h3>
                    <button class="btn btn-danger" onclick="removeLoan('${loanId}')">Remove</button>
                </div>
                <div class="grid">
                    <div class="form-group">
                        <label>Purpose/Description</label>
                        <input type="text" id="${loanId}_purpose" placeholder="e.g., Car loan">
                    </div>
                    <div class="form-group">
                        <label>Interest Rate (%)</label>
                        <input type="number" id="${loanId}_rate" min="0" max="50" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Current Balance ($)</label>
                        <input type="number" id="${loanId}_balance" min="0">
                    </div>
                    <div class="form-group">
                        <label>Monthly Payment ($)</label>
                        <input type="number" id="${loanId}_payment" min="0">
                    </div>
                </div>
            `;
            loanDiv.id = loanId;
            
            document.getElementById('loansList').appendChild(loanDiv);
            // Bring the newly added loan into view and focus the first field, unless prevented
            if (!preventFocus) {
                try { loanDiv.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch(_) {}
                const firstInput = document.getElementById(`${loanId}_purpose`);
                if (firstInput) firstInput.focus();
            }
            loans.push(loanId);
            
            // Add event listeners
            ['purpose', 'rate', 'balance', 'payment'].forEach(field => {
                document.getElementById(`${loanId}_${field}`).addEventListener('input', updateCalculator);
            });
            
            updateCalculator();
        }
        
        function removeLoan(loanId) {
            document.getElementById(loanId).remove();
            loans = loans.filter(id => id !== loanId);
            updateCalculator();
        }
        
        function calculateTax(income, filingStatus) {
            // Accurate progressive bracket application (no +1 off-by-one)
            const brackets = taxBrackets[filingStatus];
            if (!brackets) return 0;
            if (income <= 0) return 0;
            let tax = 0;
            for (const b of brackets) {
                if (income <= b.min) break; // nothing taxable in this or later brackets
                const upper = Math.min(income, b.max);
                const taxableHere = Math.max(0, upper - b.min);
                if (taxableHere > 0) tax += taxableHere * b.rate;
                if (income <= b.max) break; // done
            }
            return tax;
        }

        // Amortization summary with precise month-by-month simulation
        function amortizationSummary(principal, monthlyRate, payment) {
            if (principal <= 0) return { months: 0, interest: 0, payments: 0 };
            if (monthlyRate === 0) {
                if (payment <= 0) return { months: Infinity, interest: 0, payments: Infinity, negativeAmortization: true };
                const monthsExact = principal / payment;
                const fullMonths = Math.floor(monthsExact);
                const remainder = principal - fullMonths * payment;
                const months = remainder > 0 ? fullMonths + 1 : fullMonths;
                const payments = remainder > 0 ? fullMonths * payment + remainder : fullMonths * payment;
                return { months, interest: 0, payments };
            }
            if (payment <= principal * monthlyRate) {
                // Negative amortization scenario
                return { months: Infinity, interest: Infinity, payments: Infinity, negativeAmortization: true };
            }
            let bal = principal;
            let months = 0;
            let interest = 0;
            let payments = 0;
            while (bal > 0 && months < 1000) {
                const interestPortion = bal * monthlyRate;
                const principalPortion = Math.min(payment - interestPortion, bal);
                const actualPayment = interestPortion + principalPortion;
                interest += interestPortion;
                bal -= principalPortion;
                payments += actualPayment;
                months++;
            }
            return { months, interest, payments };
        }
            // Detailed amortization schedule returning per-month interest array
            function amortizationSchedule(principal, monthlyRate, payment) {
                const interests = [];
                if (principal <= 0) return interests;
                if (monthlyRate === 0) {
                    if (payment <= 0) return interests;
                    let bal = principal;
                    while (bal > 0 && interests.length < 1000) {
                        const principalPortion = Math.min(payment, bal);
                        interests.push(0);
                        bal -= principalPortion;
                    }
                    return interests;
                }
                if (payment <= principal * monthlyRate) return interests; // negative amortization unsupported
                let bal = principal;
                while (bal > 0 && interests.length < 1000) {
                    const interestPortion = bal * monthlyRate;
                    const principalPortion = Math.min(payment - interestPortion, bal);
                    interests.push(interestPortion);
                    bal -= principalPortion;
                }
                return interests;
            }

        let lastLoanSliderChanged = null; // track last adjusted loan slider for constraint logic
    let loanBreakdownCollapsed = false; // persist breakdown toggle state across renders
    // Standard deduction & age 65 additional amounts (approx 2024)
    const standardDeduction = {
        single: 14600,
        marriedJoint: 29200,
        headOfHousehold: 21900,
        marriedSeparate: 14600
    };
    const age65AddlAmount = {
        single: 1900,
        marriedJoint: 1500,
        headOfHousehold: 1900,
        marriedSeparate: 1500
    };

    function computeTaxable(grossIncome, filingStatus, applyStd, itemizedValue, age65Mode){
        let deductionUsed = 0;
        if (applyStd) {
            if (itemizedValue > 0) {
                deductionUsed = itemizedValue;
            } else {
                const base = standardDeduction[filingStatus] || 0;
                let addl = 0;
                if (age65Mode === 'primary') addl = age65AddlAmount[filingStatus] || 0;
                else if (age65Mode === 'both' && filingStatus === 'marriedJoint') addl = 2 * (age65AddlAmount[filingStatus] || 0);
                deductionUsed = base + addl;
            }
        } else {
            if (itemizedValue > 0) deductionUsed = itemizedValue; else deductionUsed = 0;
        }
        const taxable = Math.max(0, grossIncome - deductionUsed);
        return { deductionUsed, taxable };
    }
        
        function updateCalculator() {
            const hasLoans = loans.length > 0;
            const calculatorSection = document.getElementById('calculatorSection');
            const resultsSection = document.getElementById('results');
            
            if (hasLoans) {
                calculatorSection.classList.remove('hidden');
                resultsSection.classList.remove('hidden');
                updateSliders();
                calculateResults();
            } else {
                calculatorSection.classList.add('hidden');
                resultsSection.classList.add('hidden');
            }
        }
        
        function updateSliders() {
            const retirementBalance = parseFloat(document.getElementById('retirementBalance').value) || 0;
            const withdrawalSlider = document.getElementById('withdrawalSlider');
            withdrawalSlider.max = retirementBalance;
            
            // Create loan payoff sliders
            const slidersDiv = document.getElementById('loanSliders');
            slidersDiv.innerHTML = '';
            
            let totalMonthlyPayments = 0;
            
            loans.forEach(loanId => {
                const balance = parseFloat(document.getElementById(`${loanId}_balance`).value) || 0;
                const monthlyPayment = parseFloat(document.getElementById(`${loanId}_payment`).value) || 0;
                const purpose = document.getElementById(`${loanId}_purpose`).value || 'Loan';
                
                totalMonthlyPayments += monthlyPayment;
                
                const sliderDiv = document.createElement('div');
                sliderDiv.className = 'slider-container';
                sliderDiv.innerHTML = `
                    <label>Pay towards ${purpose}: $<span id="${loanId}_paymentAmount">${balance.toLocaleString('en-US', {maximumFractionDigits: 0})}</span></label>
                    <input type="range" id="${loanId}_paymentSlider" class="slider" min="0" max="${balance}" value="${balance}" step="1">
                `;
                slidersDiv.appendChild(sliderDiv);
                
                document.getElementById(`${loanId}_paymentSlider`).addEventListener('input', (e) => { lastLoanSliderChanged = loanId; calculateResults(); });
            });
            
            // Update Roth redirect slider max
            const rothSlider = document.getElementById('rothRedirectSlider');
            if (rothSlider) {
                // Max will be set during calculateResults based on actually freed payments
            }
        }
        
    let lastFreedMonthly = 0; // tracks max available to redirect

    function calculateResults() {
            const grossIncome = parseFloat(document.getElementById('taxableIncome').value) || 0;
            const filingStatus = document.getElementById('filingStatus').value;
            const accountType = document.getElementById('accountType').value;
            const retirementBalance = parseFloat(document.getElementById('retirementBalance').value) || 0;
            const expectedReturn = parseFloat(document.getElementById('expectedReturn').value) / 100 || 0.07;
            let withdrawal = parseFloat(document.getElementById('withdrawalSlider').value) || 0;
            const projectionYears = parseInt(document.getElementById('projectionYears')?.value || '10', 10);
            const contribMonths = projectionYears * 12; // full-horizon months
            // Roth redirect inputs (we'll compute contributions after we know paid-off loans)
            const rothRedirectEnabled = document.getElementById('rothRedirectCheck').checked;
            const rothMonthlyAmount = parseFloat(document.getElementById('rothRedirectSlider').value) || 0;
            let rothFutureValue = 0;
            let rothContributions = 0;
            const applyStd = document.getElementById('applyStandardDeduction').checked;
            const itemizedValue = parseFloat(document.getElementById('itemizedDeduction').value) || 0;
            const age65Mode = document.getElementById('age65Addl').value;
            const stateTaxRate = (parseFloat(document.getElementById('stateTaxRate').value) || 0)/100;

                document.getElementById('withdrawalAmount').textContent = withdrawal.toLocaleString('en-US', {maximumFractionDigits: 0});            // Sum chosen lump-sum allocations to loans (payment sliders represent lump sums)
            let totalLoanPayments = 0;
            loans.forEach(loanId => {
                const slider = document.getElementById(`${loanId}_paymentSlider`);
                if (slider) {
                    const val = parseFloat(slider.value) || 0;
                    totalLoanPayments += val;
                    const amtSpan = document.getElementById(`${loanId}_paymentAmount`);
                    if (amtSpan) amtSpan.textContent = val.toLocaleString('en-US', {maximumFractionDigits: 0});
                }
            });

            // Auto-withdraw logic: size withdrawal to exactly fund allocations after tax/penalty
            const autoWithdraw = document.getElementById('autoWithdrawCheck')?.checked;
            if (autoWithdraw) {
                const targetAfterTax = totalLoanPayments;
                const maxW = retirementBalance;
                
                if (accountType === 'roth') {
                    // Roth: no taxes/penalties, so withdrawal = target amount
                    withdrawal = Math.min(targetAfterTax, retirementBalance);
                } else {
                    // Traditional: need to solve for withdrawal that yields target after taxes/penalties
                    const tol = 0.01;
                    let lo = 0, hi = maxW, best = 0;
                    const afterTaxFor = (w) => {
                        const base = computeTaxable(grossIncome, filingStatus, applyStd, itemizedValue, age65Mode);
                        const aft = computeTaxable(grossIncome + w, filingStatus, applyStd, itemizedValue, age65Mode);
                        const currTax = calculateTax(base.taxable, filingStatus);
                        const newTaxV = calculateTax(aft.taxable, filingStatus);
                        const addFed = newTaxV - currTax;
                        const addState = w * stateTaxRate;
                        const penalty = (document.getElementById('earlyPenaltyCheck')?.checked) ? w * 0.10 : 0;
                        return w - (addFed + addState) - penalty;
                    };
                    for (let i = 0; i < 40; i++) {
                        const mid = (lo + hi) / 2;
                        const aft = afterTaxFor(mid);
                        if (aft >= targetAfterTax) { best = mid; hi = mid; } else { lo = mid; }
                        if (hi - lo < tol) break;
                    }
                    withdrawal = Math.min(best, retirementBalance);
                }
                
                // Reflect in UI
                const wSlider = document.getElementById('withdrawalSlider');
                if (wSlider) wSlider.value = withdrawal;
                document.getElementById('withdrawalAmount').textContent = withdrawal.toLocaleString('en-US', {maximumFractionDigits: 0});
            }

            // Tax and penalty calculations (conditional based on account type)
            let additionalTaxFederal = 0;
            let additionalTaxState = 0; 
            let additionalTax = 0;
            let incrementalTaxable = 0;
            let shieldPortion = 0;
            let earlyPenalty = 0;
            let baseTaxable = { deductionUsed: 0, taxable: 0 };
            let afterTaxable = { deductionUsed: 0, taxable: 0 };

            if (accountType === 'traditional') {
                // Traditional account: full tax treatment
                baseTaxable = computeTaxable(grossIncome, filingStatus, applyStd, itemizedValue, age65Mode);
                afterTaxable = computeTaxable(grossIncome + withdrawal, filingStatus, applyStd, itemizedValue, age65Mode);
                const currentTax = calculateTax(baseTaxable.taxable, filingStatus);
                const newTax = calculateTax(afterTaxable.taxable, filingStatus);
                additionalTaxFederal = newTax - currentTax;
                additionalTaxState = withdrawal * stateTaxRate; // flat model on full withdrawal
                additionalTax = additionalTaxFederal + additionalTaxState;
                incrementalTaxable = afterTaxable.taxable - baseTaxable.taxable;
                shieldPortion = Math.max(0, withdrawal - incrementalTaxable);

                // Early withdrawal penalty (traditional accounts)
                const earlyPenaltyEnabled = document.getElementById('earlyPenaltyCheck')?.checked;
                earlyPenalty = earlyPenaltyEnabled ? withdrawal * 0.10 : 0;
            } else if (accountType === 'roth') {
                // Roth IRA: no taxes or penalties on contribution withdrawals
                baseTaxable = computeTaxable(grossIncome, filingStatus, applyStd, itemizedValue, age65Mode);
                afterTaxable = baseTaxable; // No change to taxable income
                additionalTaxFederal = 0;
                additionalTaxState = 0;
                additionalTax = 0;
                incrementalTaxable = 0;
                shieldPortion = 0;
                earlyPenalty = 0; // No penalties on Roth contribution withdrawals
            }

            // After-tax cash
            const afterTaxWithdrawal = withdrawal - additionalTax - earlyPenalty;

            // Enforce after-tax cash constraint against selected loan allocations (skip if auto-withdraw is on)
            if (!autoWithdraw && totalLoanPayments > afterTaxWithdrawal && lastLoanSliderChanged) {
                const overflow = totalLoanPayments - afterTaxWithdrawal;
                const slider = document.getElementById(`${lastLoanSliderChanged}_paymentSlider`);
                if (slider) {
                    const currentVal = parseFloat(slider.value) || 0;
                    const newVal = Math.max(0, currentVal - overflow);
                    slider.value = newVal;
                    document.getElementById(`${lastLoanSliderChanged}_paymentAmount`).textContent = parseFloat(newVal).toLocaleString('en-US', {maximumFractionDigits: 0});
                    // Recompute total
                    totalLoanPayments = 0;
                    loans.forEach(id => {
                        const s = document.getElementById(`${id}_paymentSlider`);
                        if (s) totalLoanPayments += parseFloat(s.value) || 0;
                    });
                }
            }

            const remainingCash = afterTaxWithdrawal - totalLoanPayments;
            document.getElementById('remainingCash').textContent = remainingCash.toLocaleString('en-US', {maximumFractionDigits: 0});

            // Future growth foregone (lump sum left invested)
            const newRetirementBalance = retirementBalance - withdrawal;
            const futureValueLost = withdrawal * Math.pow(1 + expectedReturn, projectionYears);
            
            // Market-adjusted foregone growth calculation
            const marketTimingEnabled = document.getElementById('marketTimingEnabled')?.checked;
            let marketAdjustedFutureValueLost = futureValueLost;
            let marketTimingBenefit = 0;
            
            if (marketTimingEnabled) {
                const correctionPct = (parseFloat(document.getElementById('marketCorrectionPct')?.value) || 30) / 100;
                const recoveryYears = parseFloat(document.getElementById('recoveryTimeYears')?.value) || 3;
                
                // Market correction scenario: funds withdrawn avoid the correction but miss recovery growth
                // Assumes correction happens in year 1, recovery takes specified time
                const correctionYear = 1; // correction happens early
                const postRecoveryYears = Math.max(0, projectionYears - recoveryYears);
                
                // Value if funds stayed invested through correction and recovery
                let marketScenarioValue = withdrawal;
                
                // Apply correction in year 1
                marketScenarioValue *= (1 - correctionPct);
                
                // Recovery period: gradual return to pre-correction level
                if (recoveryYears > 0 && postRecoveryYears >= 0) {
                    const recoveryRate = Math.pow(1 / (1 - correctionPct), 1 / recoveryYears) - 1;
                    marketScenarioValue *= Math.pow(1 + recoveryRate, recoveryYears);
                    
                    // Post-recovery growth at normal expected return
                    if (postRecoveryYears > 0) {
                        marketScenarioValue *= Math.pow(1 + expectedReturn, postRecoveryYears);
                    }
                }
                
                marketAdjustedFutureValueLost = marketScenarioValue;
                marketTimingBenefit = futureValueLost - marketAdjustedFutureValueLost;
            }

            // Roth redirect future value (only from monthly redirected payments)
            // Ensure the options panel visibility matches the checkbox state
            const rothOptionsPanel = document.getElementById('rothRedirectOptions');
            if (rothOptionsPanel) {
                if (rothRedirectEnabled) rothOptionsPanel.classList.remove('hidden');
                else rothOptionsPanel.classList.add('hidden');
            }
            // Defer actual Roth contribution math until after loan payoff pass

            // Loan payoff impact simulation
            let totalInterestSaved = 0;
            let freedMonthlyPayments = 0;
            const loanBreakdown = [];
            loans.forEach(loanId => {
                const balance = parseFloat(document.getElementById(`${loanId}_balance`).value) || 0;
                const rateMonthly = (parseFloat(document.getElementById(`${loanId}_rate`).value) || 0) / 100 / 12;
                const monthlyPayment = parseFloat(document.getElementById(`${loanId}_payment`).value) || 0;
                const slider = document.getElementById(`${loanId}_paymentSlider`);
                const lumpApplied = slider ? (parseFloat(slider.value) || 0) : 0;
                const purpose = (document.getElementById(`${loanId}_purpose`).value || 'Loan').trim();
                if (balance <= 0 || monthlyPayment <= 0) return;
                const newBalance = Math.max(0, balance - lumpApplied);
                const originalA = amortizationSummary(balance, rateMonthly, monthlyPayment);
                if (originalA.negativeAmortization) {
                    loanBreakdown.push({ purpose, warning: 'Payment too low to amortize (negative amortization).' });
                    return;
                }
                let newA = { months: 0, interest: 0, payments: 0 };
                if (newBalance > 0) {
                    newA = amortizationSummary(newBalance, rateMonthly, monthlyPayment);
                    if (newA.negativeAmortization) return; // skip invalid scenario
                }
                const interestSaved = Math.max(0, originalA.interest - newA.interest);
                totalInterestSaved += interestSaved;
                if (newBalance < 0.01) freedMonthlyPayments += monthlyPayment; // Use small tolerance for "paid off"
                loanBreakdown.push({
                    purpose,
                    balance,
                    paymentMade: lumpApplied,
                    monthlyPayment,
                    rateAnnual: rateMonthly * 12 * 100,
                    originalMonths: originalA.months,
                    newMonths: newA.months,
                    monthsSaved: originalA.months - newA.months,
                    originalInterest: originalA.interest,
                    newInterest: newA.interest,
                    interestSaved,
                    newBalance
                });
            });
            lastLoanBreakdownRows = loanBreakdown;

            // Adjust Roth slider max based on freed monthly payments
            const rothSlider = document.getElementById('rothRedirectSlider');
            if (rothSlider) {
                rothSlider.max = Math.max(freedMonthlyPayments, 1000); // Keep at least 1000 max for usability
                if (parseFloat(rothSlider.value) > freedMonthlyPayments && freedMonthlyPayments > 0) {
                    rothSlider.value = freedMonthlyPayments;
                }
                
                // Auto-max functionality and disable slider when 100% redirect is checked
                const rothMaxRedirect = document.getElementById('rothMaxRedirect')?.checked;
                if (rothMaxRedirect && freedMonthlyPayments > 0) {
                    rothSlider.value = freedMonthlyPayments;
                    rothSlider.disabled = true;
                    rothSlider.title = 'Slider disabled - using 100% of freed payments';
                } else {
                    rothSlider.disabled = false;
                    rothSlider.title = '';
                }
                
                updateRothDisplay();
            }
            lastFreedMonthly = freedMonthlyPayments;

            // Compose results HTML
            const resultsContent = document.getElementById('resultsContent');
            let mainHtml = '';
            const immediateCashImpact = - (additionalTax + earlyPenalty);

            // Compute Roth contributions and FV now that we know which loans were fully paid
            if (rothRedirectEnabled && rothMonthlyAmount > 0) {
                const monthlyRate = expectedReturn / 12;
                const totalHorizonMonths = contribMonths;
                const remainingTermMode = document.getElementById('rothTermRemaining')?.checked;
                
                // Effective monthly contribution (capped by available freed payments)
                const effectiveMonthlyContrib = Math.min(rothMonthlyAmount, freedMonthlyPayments);
                
                if (remainingTermMode) {
                    // Build per-month available redirect based on each fully-paid loan's original schedule
                    const paidLoans = lastLoanBreakdownRows.filter(lb => !lb.warning && lb.newBalance < 0.01 && lb.originalMonths > 0);
                    const maxMonths = paidLoans.reduce((m, lb) => Math.max(m, lb.originalMonths || 0), 0);
                    const avail = new Array(maxMonths).fill(0);
                    paidLoans.forEach(lb => {
                        for (let m = 0; m < (lb.originalMonths || 0); m++) avail[m] += (lb.monthlyPayment || 0);
                    });
                    let fv = 0;
                    let contribSum = 0;
                    for (let m = 0; m < maxMonths; m++) {
                        const monthlyAvailable = avail[m] || 0;
                        const c = Math.min(effectiveMonthlyContrib, monthlyAvailable);
                        contribSum += c;
                        if (monthlyRate === 0) {
                            fv += c;
                        } else {
                            fv = fv * (1 + monthlyRate) + c;
                        }
                    }
                    // Grow remaining months to the full projection horizon
                    if (monthlyRate > 0 && totalHorizonMonths > maxMonths) {
                        fv *= Math.pow(1 + monthlyRate, totalHorizonMonths - maxMonths);
                    }
                    rothContributions = contribSum;
                    rothFutureValue = fv;
                } else {
                    // Full-horizon constant contribution (capped by actual freed monthly payments)
                    rothContributions = effectiveMonthlyContrib * totalHorizonMonths;
                    rothFutureValue = monthlyRate === 0
                        ? effectiveMonthlyContrib * totalHorizonMonths
                        : effectiveMonthlyContrib * (Math.pow(1 + monthlyRate, totalHorizonMonths) - 1) / monthlyRate;
                }
            }

            // Compute breakeven and next-12-months interest avoided
            let interestDiffTimeline = [];
            loans.forEach(loanId => {
                const balance = parseFloat(document.getElementById(`${loanId}_balance`).value) || 0;
                const rateMonthly = (parseFloat(document.getElementById(`${loanId}_rate`).value) || 0) / 100 / 12;
                const monthlyPayment = parseFloat(document.getElementById(`${loanId}_payment`).value) || 0;
                const slider = document.getElementById(`${loanId}_paymentSlider`);
                const lumpApplied = slider ? (parseFloat(slider.value) || 0) : 0;
                if (balance <= 0 || monthlyPayment <= 0 || lumpApplied <= 0) return;
                const orig = amortizationSchedule(balance, rateMonthly, monthlyPayment);
                const newBal = Math.max(0, balance - lumpApplied);
                const alt = newBal > 0 ? amortizationSchedule(newBal, rateMonthly, monthlyPayment) : [];
                const maxLen = Math.max(orig.length, alt.length);
                for (let i = 0; i < maxLen; i++) {
                    const d = (orig[i] || 0) - (alt[i] || 0);
                    interestDiffTimeline[i] = (interestDiffTimeline[i] || 0) + Math.max(0, d);
                }
            });
            const next12InterestAvoided = interestDiffTimeline.slice(0,12).reduce((a,b)=>a+b,0);
            let taxesPenalties = additionalTax + earlyPenalty;
            let breakevenMonths = null;
            if (interestDiffTimeline.length > 0) {
                let cum = 0;
                for (let i = 0; i < interestDiffTimeline.length; i++) {
                    cum += interestDiffTimeline[i];
                    if (cum + 1e-6 >= taxesPenalties) { breakevenMonths = i+1; break; }
                }
            }
            // Defer rendering of these values until after the base metrics block

            const accountTypeName = accountType === 'roth' ? 'Roth IRA' : 'Traditional Retirement Account';
            mainHtml += `<div class=\"metric\"><span>${accountTypeName} Withdrawal:</span><span class=\"metric-value\">$${withdrawal.toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
            
            if (accountType === 'traditional') {
                if (applyStd || itemizedValue>0) mainHtml += `<div class=\"metric\"><span>Deduction Used:</span><span class=\"metric-value\">$${baseTaxable.deductionUsed.toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
                mainHtml += `<div class=\"metric\"><span><span class=\"calc-link\" onclick=\"toggleCalcExplanation('taxCalc')\">Total Additional Tax (Fed + State):</span></span><span class=\"metric-value\">$${additionalTax.toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
                mainHtml += `<div id=\"taxCalc\" class=\"calc-explanation\">Federal: $${additionalTaxFederal.toLocaleString('en-US', {maximumFractionDigits: 0})} + State: $${additionalTaxState.toLocaleString('en-US', {maximumFractionDigits: 0})} = $${additionalTax.toLocaleString('en-US', {maximumFractionDigits: 0})}<br>Federal calculated using progressive tax brackets on incremental taxable income. State applied as flat rate (${(stateTaxRate*100).toFixed(1)}%) on full withdrawal.</div>`;
            } else {
                mainHtml += `<div class=\"metric\"><span><span class=\"calc-link\" onclick=\"toggleCalcExplanation('taxCalc')\">Tax on Roth Withdrawal:</span></span><span class=\"metric-value\">$0</span></div>`;
                mainHtml += `<div id=\"taxCalc\" class=\"calc-explanation\">Roth IRA contribution withdrawals are always tax-free and penalty-free, regardless of age. This assumes you're withdrawing contributions only, not earnings.</div>`;
            }
            if (accountType === 'traditional') {
                if (stateTaxRate>0) mainHtml += `<div class=\"metric\"><span>&nbsp;↳ State Portion (Flat):</span><span class=\"metric-value\">$${additionalTaxState.toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
                if (applyStd || itemizedValue>0) mainHtml += `<div class=\"metric\"><span><span class=\"calc-link\" onclick=\"toggleCalcExplanation('shieldCalc')\">Withdrawal Shielded by Deduction:</span></span><span class=\"metric-value\">$${shieldPortion.toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
                if (applyStd || itemizedValue>0) mainHtml += `<div id=\"shieldCalc\" class=\"calc-explanation\">Amount of withdrawal protected from federal taxes by unused deduction capacity. Withdrawal ($${withdrawal.toLocaleString('en-US', {maximumFractionDigits: 0})}) - Additional Taxable Income ($${incrementalTaxable.toLocaleString('en-US', {maximumFractionDigits: 0})}) = $${shieldPortion.toLocaleString('en-US', {maximumFractionDigits: 0})} shielded.<br><br><strong>Bottom Line:</strong> Shielding mainly helps people with very low current income. Most middle-to-upper income earners see little to no shielding because their income already uses up most of their available deductions. <a href=\"ShieldedByDeduction.md\" target=\"_blank\" style=\"color:#FFE5B4;\">See detailed examples →</a></div>`;
                if (earlyPenalty > 0) mainHtml += `<div class=\"metric impact-penalty\"><span>Early Withdrawal Penalty (10%):</span><span class=\"metric-value\">$${earlyPenalty.toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
            } else {
                mainHtml += `<div class=\"metric\"><span><span class=\"calc-link\" onclick=\"toggleCalcExplanation('penaltyCalc')\">Early Withdrawal Penalty:</span></span><span class=\"metric-value\">$0</span></div>`;
                mainHtml += `<div id=\"penaltyCalc\" class=\"calc-explanation\">Roth IRA contributions can be withdrawn penalty-free at any age. Only earnings withdrawals before age 59½ are subject to penalties.</div>`;
            }
            mainHtml += `<div class=\"metric\"><span><span class=\"calc-link\" onclick=\"toggleCalcExplanation('afterTaxCalc')\">Cash Available for Loans:</span></span><span class=\"metric-value\">$${afterTaxWithdrawal.toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
            if (accountType === 'traditional') {
                mainHtml += `<div id=\"afterTaxCalc\" class=\"calc-explanation\">Gross Withdrawal ($${withdrawal.toLocaleString('en-US', {maximumFractionDigits: 0})}) - Taxes ($${additionalTax.toLocaleString('en-US', {maximumFractionDigits: 0})}) - Penalties ($${earlyPenalty.toLocaleString('en-US', {maximumFractionDigits: 0})}) = $${afterTaxWithdrawal.toLocaleString('en-US', {maximumFractionDigits: 0})} available for loan payments.</div>`;
            } else {
                mainHtml += `<div id=\"afterTaxCalc\" class=\"calc-explanation\">Roth Withdrawal ($${withdrawal.toLocaleString('en-US', {maximumFractionDigits: 0})}) - Taxes ($0) - Penalties ($0) = $${afterTaxWithdrawal.toLocaleString('en-US', {maximumFractionDigits: 0})} available for loan payments. Full withdrawal amount is available since Roth contributions are tax-free.</div>`;
            }
            mainHtml += `<div class=\"metric\"><span>Applied to Loans:</span><span class=\"metric-value\">$${totalLoanPayments.toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
            mainHtml += `<div class=\"metric\"><span>Remaining Cash:</span><span class=\"metric-value\">$${remainingCash.toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
            mainHtml += `<div class=\"metric\"><span>New Retirement Balance:</span><span class=\"metric-value\">$${newRetirementBalance.toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
            mainHtml += `<hr style=\"border-color: rgba(255,255,255,0.3);\">`;
            mainHtml += `<div class=\"metric\"><span><span class=\"calc-link\" onclick=\"toggleCalcExplanation('interestCalc')\">Total Future Interest Avoided:</span></span><span class=\"metric-value\">$${totalInterestSaved.toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
            mainHtml += `<div id=\"interestCalc\" class=\"calc-explanation\">Sum of interest saved across all loans by applying lump-sum payments. Calculated by comparing original amortization schedules vs. new schedules with reduced principal balances. This represents the total interest you will NOT pay over the remaining life of each loan.</div>`;
            taxesPenalties = additionalTax + earlyPenalty;
            mainHtml += `<div class=\"metric\"><span><span class=\"calc-link\" onclick=\"toggleCalcExplanation('netSavingsCalc')\">Immediate Net Savings (Interest Saved less Taxes):</span></span><span class=\"metric-value\">${(totalInterestSaved - taxesPenalties) >= 0 ? '+' : ''}$${(totalInterestSaved - taxesPenalties).toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
            mainHtml += `<div id=\"netSavingsCalc\" class=\"calc-explanation\">Simple comparison: Interest Saved ($${totalInterestSaved.toLocaleString('en-US', {maximumFractionDigits: 0})}) - Taxes & Penalties ($${taxesPenalties.toLocaleString('en-US', {maximumFractionDigits: 0})}) = ${(totalInterestSaved - taxesPenalties) >= 0 ? 'Net Benefit' : 'Net Cost'} of $${Math.abs(totalInterestSaved - taxesPenalties).toLocaleString('en-US', {maximumFractionDigits: 0})}. This ignores opportunity cost of withdrawn funds.</div>`;
            if (next12InterestAvoided > 0) mainHtml += `<div class=\"metric\"><span><span class=\"calc-link\" onclick=\"toggleCalcExplanation('next12Calc')\">Interest avoided next 12 months:</span></span><span class=\"metric-value\">$${next12InterestAvoided.toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
            if (next12InterestAvoided > 0) mainHtml += `<div id=\"next12Calc\" class=\"calc-explanation\">Interest you will avoid paying in the next 12 months due to the lump-sum payments. Calculated by comparing month-by-month interest charges on original vs. new loan balances.</div>`;
            if (breakevenMonths != null) mainHtml += `<div class=\"metric\"><span><span class=\"calc-link\" onclick=\"toggleCalcExplanation('breakevenCalc')\">Breakeven time (no growth):</span></span><span class=\"metric-value\">${breakevenMonths} month${breakevenMonths===1?'':'s'}</span></div>`;
            if (breakevenMonths != null) mainHtml += `<div id=\"breakevenCalc\" class=\"calc-explanation\">Time until cumulative interest avoided ($${next12InterestAvoided.toLocaleString('en-US', {maximumFractionDigits: 0})} in first 12 months) equals the upfront cost of taxes and penalties ($${taxesPenalties.toLocaleString('en-US', {maximumFractionDigits: 0})}). This is a simple payback period ignoring opportunity cost.</div>`;
            // Oversize-withdrawal warning if withdrawal dwarfs loan allocation and auto-withdraw is off
            if (!autoWithdraw && totalLoanPayments > 0 && withdrawal > totalLoanPayments * 2) {
                const ratio = (withdrawal / (totalLoanPayments || 1)).toFixed(1);
                mainHtml += `<div class=\"warning\"><strong>Warning:</strong> You're withdrawing $${withdrawal.toLocaleString('en-US', {maximumFractionDigits: 0})} to fund $${totalLoanPayments.toLocaleString('en-US', {maximumFractionDigits: 0})} in paydowns (≈${ratio}×). Consider enabling \"Only withdraw what's needed\" to avoid excessive foregone growth.</div>`;
            }
            // Standard foregone growth
            mainHtml += `<div class=\"metric\"><span><span class=\"calc-link\" onclick=\"toggleCalcExplanation('foregoneCalc')\">Foregone Growth (Standard Scenario):</span></span><span class=\"metric-value\">$${futureValueLost.toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
            mainHtml += `<div id=\"foregoneCalc\" class=\"calc-explanation\">Standard opportunity cost assuming steady ${(expectedReturn*100).toFixed(1)}% annual returns. Withdrawal ($${withdrawal.toLocaleString('en-US', {maximumFractionDigits: 0})}) × (1 + ${(expectedReturn*100).toFixed(1)}%)^${projectionYears} = $${futureValueLost.toLocaleString('en-US', {maximumFractionDigits: 0})} in potential growth over ${projectionYears} years.</div>`;
            
            // Market-adjusted foregone growth (if enabled)
            if (marketTimingEnabled) {
                const correctionPct = (parseFloat(document.getElementById('marketCorrectionPct')?.value) || 30);
                const recoveryYears = parseFloat(document.getElementById('recoveryTimeYears')?.value) || 3;
                
                mainHtml += `<div class=\"metric impact-immediate\"><span><span class=\"calc-link\" onclick=\"toggleCalcExplanation('marketForesoneCalc')\">Foregone Growth (Market Correction Scenario):</span></span><span class=\"metric-value\">$${marketAdjustedFutureValueLost.toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
                mainHtml += `<div id=\"marketForesoneCalc\" class=\"calc-explanation\">Adjusted opportunity cost assuming a ${correctionPct}% market correction in year 1, followed by ${recoveryYears}-year recovery period, then normal ${(expectedReturn*100).toFixed(1)}% growth. Your withdrawn funds avoid the correction but also miss the recovery growth.<br><br><strong>Calculation:</strong><br>• Withdrawal: $${withdrawal.toLocaleString('en-US', {maximumFractionDigits: 0})}<br>• Apply ${correctionPct}% correction in year 1<br>• Recovery over ${recoveryYears} years to pre-correction level<br>• Normal growth for remaining ${Math.max(0, projectionYears - recoveryYears)} years<br>• Final value: $${marketAdjustedFutureValueLost.toLocaleString('en-US', {maximumFractionDigits: 0})}</div>`;
                
                if (marketTimingBenefit > 0) {
                    mainHtml += `<div class=\"metric impact-roth\"><span><span class=\"calc-link\" onclick=\"toggleCalcExplanation('timingBenefitCalc')\">Market Timing Benefit:</span></span><span class=\"metric-value\">+$${marketTimingBenefit.toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
                    mainHtml += `<div id=\"timingBenefitCalc\" class=\"calc-explanation\">Benefit from withdrawing before a market correction. Standard Foregone Growth ($${futureValueLost.toLocaleString('en-US', {maximumFractionDigits: 0})}) - Market Correction Scenario ($${marketAdjustedFutureValueLost.toLocaleString('en-US', {maximumFractionDigits: 0})}) = $${marketTimingBenefit.toLocaleString('en-US', {maximumFractionDigits: 0})} saved by avoiding the correction.<br><br><strong>Note:</strong> This is speculative and assumes your market timing prediction is accurate. Market timing is notoriously difficult even for professional investors.</div>`;
                }
            }
            if (rothRedirectEnabled) {
                const remainingTermMode = document.getElementById('rothTermRemaining')?.checked;
                if (remainingTermMode) {
                    const paidLoans = lastLoanBreakdownRows.filter(lb => !lb.warning && lb.newBalance < 0.01 && lb.originalMonths > 0);
                    const maxMonths = paidLoans.reduce((m, lb) => Math.max(m, lb.originalMonths || 0), 0);
                    mainHtml += `<div class=\"metric impact-roth\"><span><span class=\"calc-link\" onclick=\"toggleCalcExplanation('rothContribCalc')\">Roth IRA Redirected Funding Amount (remaining term: up to ${maxMonths} mo at $${(rothMonthlyAmount||0).toLocaleString('en-US', {maximumFractionDigits: 0})}/mo):</span></span><span class=\"metric-value\">$${(rothContributions||0).toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
                } else {
                    mainHtml += `<div class=\"metric impact-roth\"><span><span class=\"calc-link\" onclick=\"toggleCalcExplanation('rothContribCalc')\">Roth IRA Redirected Funding Amount (${projectionYears} yrs: $${(rothMonthlyAmount||0).toLocaleString('en-US', {maximumFractionDigits: 0})}/mo × ${contribMonths} mo):</span></span><span class=\"metric-value\">$${(rothContributions||0).toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
                }
                mainHtml += `<div id=\"rothContribCalc\" class=\"calc-explanation\">Total contributions to Roth IRA using freed monthly loan payments. Only available from loans you completely pay off (balance = $0). Monthly contribution is limited by available freed cashflow.<br><br><strong>Calculation Factors:</strong><br>• Roth Redirection Enabled: ${rothRedirectEnabled ? 'Yes' : 'No'}<br>• Requested Monthly Amount: $${rothMonthlyAmount}<br>• Available Freed Monthly: $${freedMonthlyPayments}<br>• Actual Monthly Contribution: $${Math.min(rothMonthlyAmount, freedMonthlyPayments)}<br>• Term Limitation Mode: ${remainingTermMode ? 'Original loan term only' : 'Full projection period'}<br>• Loans Completely Paid Off: ${lastLoanBreakdownRows.filter(lb => !lb.warning && lb.newBalance < 0.01).length}<br>• Projection Time Horizon: ${projectionYears} years<br><br><strong>Calculation:</strong><br>${remainingTermMode ? 
                    `Monthly Contribution ($${Math.min(rothMonthlyAmount, freedMonthlyPayments)}) × Loan Term (${lastLoanBreakdownRows.filter(lb => !lb.warning && lb.newBalance < 0.01 && lb.originalMonths > 0).reduce((m, lb) => Math.max(m, lb.originalMonths || 0), 0)} months) = $${rothContributions.toLocaleString('en-US', {maximumFractionDigits: 0})}` :
                    `Monthly Contribution ($${Math.min(rothMonthlyAmount, freedMonthlyPayments)}) × Full Period (${projectionYears} years × 12 months) = $${Math.min(rothMonthlyAmount, freedMonthlyPayments)} × ${contribMonths} = $${rothContributions.toLocaleString('en-US', {maximumFractionDigits: 0})}`
                }</div>`;
                mainHtml += `<div class=\"metric impact-roth\"><span><span class=\"calc-link\" onclick=\"toggleCalcExplanation('rothFVCalc')\">Roth IRA Future Value (${projectionYears} yrs):</span></span><span class=\"metric-value\">+$${rothFutureValue.toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
                mainHtml += `<div id=\"rothFVCalc\" class=\"calc-explanation\">Future value of Roth contributions compounded at ${(expectedReturn*100).toFixed(1)}% annually. Calculated using monthly contribution pattern ${remainingTermMode ? 'for original loan term only' : 'for full projection period'}, then grown to ${projectionYears}-year horizon.<br><br><strong>Calculation:</strong><br>${
                    rothContributions > 0 ? 
                        (expectedReturn === 0 ? 
                            `No growth rate: $${rothContributions.toLocaleString('en-US', {maximumFractionDigits: 0})} (contributions only)` :
                            `Monthly Contribution ($${Math.min(rothMonthlyAmount, freedMonthlyPayments)}) × Future Value Annuity Factor = $${rothFutureValue.toLocaleString('en-US', {maximumFractionDigits: 0})}<br>Using ${(expectedReturn*100).toFixed(1)}%/year (${((expectedReturn/12)*100).toFixed(3)}%/month) for ${remainingTermMode ? lastLoanBreakdownRows.filter(lb => !lb.warning && lb.newBalance < 0.01 && lb.originalMonths > 0).reduce((m, lb) => Math.max(m, lb.originalMonths || 0), 0) : contribMonths} months`) :
                        'No contributions = No future value'
                }</div>`;
                if ((lastFreedMonthly || 0) === 0) {
                    mainHtml += `<div class=\"tax-info\"><strong>Why $0?</strong> Roth redirection only uses monthly payments from loans you completely pay off. No loans were fully paid, so there's no monthly cashflow to redirect.</div>`;
                } else if (rothMonthlyAmount === 0) {
                    mainHtml += `<div class=\"tax-info\">Set a monthly redirect above $0 (up to $${(lastFreedMonthly||0).toLocaleString('en-US', {maximumFractionDigits: 0})}) to see projected Roth growth.</div>`;
                }
            }
            const effectiveFutureValueLost = marketTimingEnabled ? marketAdjustedFutureValueLost : futureValueLost;
            const netWealthImpact = totalInterestSaved - additionalTax - earlyPenalty - effectiveFutureValueLost + (rothRedirectEnabled ? rothFutureValue : 0);
            mainHtml += `<div class=\"metric\"><span><strong><span class=\"calc-link\" onclick=\"toggleCalcExplanation('netImpactCalc')\">Net ${projectionYears}-Year Impact (All Factors):</span></strong></span><span class=\"metric-value\"><strong>${netWealthImpact >= 0 ? '+' : ''}$${netWealthImpact.toLocaleString('en-US', {maximumFractionDigits: 0})}</strong></span></div>`;
            const foregoneLabel = marketTimingEnabled ? `Foregone Growth (Market Correction): $${effectiveFutureValueLost.toLocaleString('en-US', {maximumFractionDigits: 0})}` : `Foregone Growth: $${effectiveFutureValueLost.toLocaleString('en-US', {maximumFractionDigits: 0})}`;
            mainHtml += `<div id=\"netImpactCalc\" class=\"calc-explanation\"><strong>Complete Financial Impact${marketTimingEnabled ? ' (Market Correction Scenario)' : ''}:</strong><br>+ Interest Saved: $${totalInterestSaved.toLocaleString('en-US', {maximumFractionDigits: 0})}<br>- Taxes & Penalties: $${taxesPenalties.toLocaleString('en-US', {maximumFractionDigits: 0})}<br>- ${foregoneLabel}${rothRedirectEnabled ? '<br>+ Roth IRA Growth: $' + rothFutureValue.toLocaleString('en-US', {maximumFractionDigits: 0}) : ''}<br>= <strong>Net Impact: ${netWealthImpact >= 0 ? '+' : ''}$${netWealthImpact.toLocaleString('en-US', {maximumFractionDigits: 0})}</strong>${marketTimingEnabled ? '<br><br><em>This calculation uses the market correction scenario. Disable "Factor in potential market correction" to see standard scenario.</em>' : ''}</div>`;

            // Add special callout for Roth vs Traditional comparison
            if (accountType === 'roth') {
                const traditionalTaxesPenalties = withdrawal * 0.25; // Rough estimate for comparison
                const traditionalNetImpact = totalInterestSaved - traditionalTaxesPenalties - futureValueLost + (rothRedirectEnabled ? rothFutureValue : 0);
                const rothAdvantage = netWealthImpact - traditionalNetImpact;
                
                mainHtml += `<div class=\"tax-info\" style=\"background: #e8f5e8; border-color: #27ae60;\"><strong>🎉 Roth IRA Advantage!</strong><br>By using Roth funds instead of traditional retirement account withdrawals, you avoid an estimated $${traditionalTaxesPenalties.toLocaleString('en-US', {maximumFractionDigits: 0})} in taxes and penalties (assuming ~25% effective rate).<br><br><strong>Estimated advantage over traditional withdrawal: +$${rothAdvantage.toLocaleString('en-US', {maximumFractionDigits: 0})}</strong><br><br><em>This makes loan payoff much more attractive since you get the full withdrawal amount to work with!</em></div>`;
            }


            //Add Comment
        
            // Tax rate breakdown
            if (withdrawal > 0) {
                let marginalFederal = 0;
                const brackets = taxBrackets[filingStatus];
                for (const b of brackets) { if (afterTaxable.taxable <= b.max) { marginalFederal = b.rate; break; } }
                const marginalState = stateTaxRate;
                const effectiveFederal = additionalTaxFederal > 0 ? (additionalTaxFederal / withdrawal) : 0;
                const effectiveState = additionalTaxState > 0 ? (additionalTaxState / withdrawal) : 0;
                const effectiveCombined = additionalTax / withdrawal;
                const shieldPct = shieldPortion > 0 ? shieldPortion / withdrawal : 0;
                const penaltyRate = earlyPenalty > 0 ? earlyPenalty / withdrawal : 0;
                const allInEffective = (additionalTax + earlyPenalty) / withdrawal;
                const pct = x => (x*100).toFixed(1).replace(/\.0$/, '');
                mainHtml += `\n<div class=\"loan-breakdown-wrapper\" id=\"taxRateBreakdown\">\n <details open>\n  <summary style=\"cursor:pointer; font-weight:600;\">Tax Rate Breakdown</summary>\n  <div class=\"loan-breakdown-grid\">\n    <div><span>Marginal Federal:</span><span>${pct(marginalFederal)}%</span></div>\n    ${marginalState>0 ? `<div><span>Marginal State:</span><span>${pct(marginalState)}%</span></div>` : ''}\n    ${marginalState>0 ? `<div><span>Marginal Combined:</span><span>${pct(marginalFederal + marginalState)}%</span></div>` : ''}\n    <div><span>Effective Federal:</span><span>${pct(effectiveFederal)}%</span></div>\n    ${marginalState>0 ? `<div><span>Effective State:</span><span>${pct(effectiveState)}%</span></div>` : ''}\n    <div><span>Effective Combined:</span><span>${pct(effectiveCombined)}%</span></div>\n    ${shieldPortion>0 ? `<div><span>Deduction Shield:</span><span>${pct(shieldPct)}% ($${shieldPortion.toLocaleString('en-US', {maximumFractionDigits: 0})})</span></div>` : ''}\n    ${earlyPenalty>0 ? `<div><span>Penalty Rate:</span><span>${pct(penaltyRate)}%</span></div>` : ''}\n    ${earlyPenalty>0 ? `<div><span>All-In Effective:</span><span>${pct(allInEffective)}%</span></div>` : ''}\n  </div>\n </details>\n</div>`;
            }

            // Loan breakdown
            if (loanBreakdown.length > 0) {
                const rows = loanBreakdown.map(lb => {
                    if (lb.warning) {
                        return `<div class="loan-breakdown-item"><strong>${lb.purpose}</strong>: ${lb.warning}</div>`;
                    }
                    return `
                        <div class="loan-breakdown-item">
                            <details open>
                                <summary>${lb.purpose}</summary>
                                <div class="grid">
                                    <div><strong>Original Loan Amount:</strong> $${lb.balance.toLocaleString('en-US', {maximumFractionDigits: 0})}</div>
                                    <div><strong>Monthly Payment:</strong> $${lb.monthlyPayment.toLocaleString('en-US', {maximumFractionDigits: 0})}</div>
                                    <div><strong>Interest Rate:</strong> ${lb.rateAnnual.toFixed(2)}%</div>
                                    <div><strong>Months Originally Scheduled:</strong> ${lb.originalMonths.toLocaleString('en-US', {maximumFractionDigits: 0})}</div>
                                    <div><strong>New Balance After Paydown:</strong> $${lb.newBalance.toLocaleString('en-US', {maximumFractionDigits: 0})}</div>
                                    <div><strong>Interest Saved:</strong> $${lb.interestSaved.toLocaleString('en-US', {maximumFractionDigits: 0})}</div>
                                    <div><strong>New Months to Payoff:</strong> ${lb.newMonths.toLocaleString('en-US', {maximumFractionDigits: 0})}</div>
                                    <div><strong>Months Reduced:</strong> ${lb.monthsSaved.toLocaleString('en-US', {maximumFractionDigits: 0})}</div>
                                </div>
                            </details>
                        </div>
                    `;
                }).join('');
                const breakdownHtml = `
                    <div class="section">
                        <h2>📊 Loan Breakdown Details</h2>
                        <div class="grid">
                            ${rows}
                        </div>
                    </div>
                `;
                mainHtml += breakdownHtml;
            }
            
            // Clear and set the complete results content in one operation
            resultsContent.innerHTML = mainHtml;
        }

        function updateRothDisplay() {
            const monthlyAmount = parseFloat(document.getElementById('rothRedirectSlider').value) || 0;
            document.getElementById('rothRedirectAmount').textContent = monthlyAmount.toLocaleString('en-US', {maximumFractionDigits: 0});
            const percentage = lastFreedMonthly > 0 ? ((monthlyAmount / lastFreedMonthly) * 100) : 0;
            document.getElementById('rothRedirectPercent').textContent = percentage.toFixed(0);
        }

        function updateMarketTimingUI() {
            const marketTimingEnabled = document.getElementById('marketTimingEnabled').checked;
            const marketTimingOptionsPanel = document.getElementById('marketTimingOptions');
            
            if (marketTimingOptionsPanel) {
                if (marketTimingEnabled) {
                    marketTimingOptionsPanel.classList.remove('hidden');
                } else {
                    marketTimingOptionsPanel.classList.add('hidden');
                }
            }
        }

        function updateAccountTypeUI() {
            const accountType = document.getElementById('accountType').value;
            const penaltyContainer = document.getElementById('earlyPenaltyContainer');
            const penaltyLabel = document.getElementById('penaltyLabel');
            const penaltyDescription = document.getElementById('penaltyDescription');
            const autoWithdrawNote = document.getElementById('autoWithdrawNote');
            const filingStatusNote = document.getElementById('filingStatusNote');
            
            if (accountType === 'roth') {
                // Hide penalty options for Roth
                penaltyContainer.style.display = 'none';
                autoWithdrawNote.textContent = 'Automatically sizes the withdrawal to cover loan allocations. No taxes or penalties on Roth contribution withdrawals.';
                // Show note that filing status is less critical for Roth
                if (filingStatusNote) filingStatusNote.classList.remove('hidden');
            } else {
                // Show penalty options for Traditional
                penaltyContainer.style.display = 'block';
                autoWithdrawNote.textContent = 'Automatically sizes the pre-tax withdrawal to cover loan allocations after tax and penalties. Prevents oversized withdrawals and inflated foregone-growth penalties.';
                // Hide the filing status note for traditional accounts
                if (filingStatusNote) filingStatusNote.classList.add('hidden');
            }
            
            // Default to 100% redirect for all account types (money is post-tax after withdrawal)
            const rothMaxRedirect = document.getElementById('rothMaxRedirect');
            if (rothMaxRedirect) rothMaxRedirect.checked = true;
        }

        function toggleCalcExplanation(id) {
            const element = document.getElementById(id);
            if (element) {
                element.classList.toggle('show');
            }
        }

        // Scenario Management
        function saveScenario() {
            // Default to current scenario name if one is loaded
            const defaultName = currentScenarioName || "";
            const promptMessage = currentScenarioName 
                ? `Update scenario "${currentScenarioName}" or enter a new name:`
                : "Enter a name for this scenario:";
            
            const name = prompt(promptMessage, defaultName);
            if (!name) return;

            const scenario = {
                taxableIncome: document.getElementById('taxableIncome').value,
                filingStatus: document.getElementById('filingStatus').value,
                accountType: document.getElementById('accountType').value,
                retirementBalance: document.getElementById('retirementBalance').value,
                expectedReturn: document.getElementById('expectedReturn').value,
                projectionYears: document.getElementById('projectionYears').value,
                stateTaxRate: document.getElementById('stateTaxRate').value,
                applyStandardDeduction: document.getElementById('applyStandardDeduction').checked,
                itemizedDeduction: document.getElementById('itemizedDeduction').value,
                age65Addl: document.getElementById('age65Addl').value,
                earlyPenaltyCheck: document.getElementById('earlyPenaltyCheck').checked,
                autoWithdrawCheck: document.getElementById('autoWithdrawCheck').checked,
                // Roth options
                rothRedirectCheck: document.getElementById('rothRedirectCheck').checked,
                rothRedirectSlider: document.getElementById('rothRedirectSlider').value,
                rothTermRemaining: document.getElementById('rothTermRemaining').checked,
                rothMaxRedirect: document.getElementById('rothMaxRedirect').checked,
                // Market timing options
                marketTimingEnabled: document.getElementById('marketTimingEnabled').checked,
                marketCorrectionPct: document.getElementById('marketCorrectionPct').value,
                recoveryTimeYears: document.getElementById('recoveryTimeYears').value,
                loans: loans.map(loanId => ({
                    purpose: document.getElementById(`${loanId}_purpose`).value,
                    rate: document.getElementById(`${loanId}_rate`).value,
                    balance: document.getElementById(`${loanId}_balance`).value,
                    payment: document.getElementById(`${loanId}_payment`).value,
                }))
            };

            localStorage.setItem(`scenario_${name}`, JSON.stringify(scenario));
            const wasUpdate = currentScenarioName === name;
            currentScenarioName = name; // Update current scenario tracking
            alert(`Scenario "${name}" ${wasUpdate ? 'updated' : 'saved'}!`);
            loadScenarioList();
            
            // Update the dropdown to show the current scenario as selected
            const select = document.getElementById('scenarioSelect');
            if (select) select.value = name;
        }

        function loadScenarioList() {
            const select = document.getElementById('scenarioSelect');
            select.innerHTML = '<option value="">-- Select a Scenario --</option>';
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('scenario_')) {
                    const name = key.split('scenario_')[1];
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    select.appendChild(option);
                }
            });
        }

        document.getElementById('scenarioSelect').addEventListener('change', function() {
            const name = this.value;
            if (!name) return;

            const scenarioJSON = localStorage.getItem(`scenario_${name}`);
            if (!scenarioJSON) {
                alert("Could not load scenario.");
                return;
            }

            const scenario = JSON.parse(scenarioJSON);

            // Reset current state
            resetApp();
            document.getElementById('loansList').innerHTML = '';
            loans = [];
            loanCounter = 0;

            // Load scenario data
            document.getElementById('taxableIncome').value = scenario.taxableIncome;
            document.getElementById('filingStatus').value = scenario.filingStatus;
            document.getElementById('accountType').value = scenario.accountType || 'traditional';
            document.getElementById('retirementBalance').value = scenario.retirementBalance;
            document.getElementById('expectedReturn').value = scenario.expectedReturn;
            document.getElementById('projectionYears').value = scenario.projectionYears || '10';
            document.getElementById('stateTaxRate').value = scenario.stateTaxRate;
            document.getElementById('applyStandardDeduction').checked = scenario.applyStandardDeduction;
            document.getElementById('itemizedDeduction').value = scenario.itemizedDeduction;
            document.getElementById('age65Addl').value = scenario.age65Addl;
            document.getElementById('earlyPenaltyCheck').checked = scenario.earlyPenaltyCheck;
            document.getElementById('autoWithdrawCheck').checked = scenario.autoWithdrawCheck;
            
            // Roth options
            document.getElementById('rothRedirectCheck').checked = scenario.rothRedirectCheck;
            document.getElementById('rothRedirectSlider').value = scenario.rothRedirectSlider;
            document.getElementById('rothTermRemaining').checked = scenario.rothTermRemaining;
            document.getElementById('rothMaxRedirect').checked = scenario.rothMaxRedirect;
            
            // Market timing options
            document.getElementById('marketTimingEnabled').checked = scenario.marketTimingEnabled || false;
            document.getElementById('marketCorrectionPct').value = scenario.marketCorrectionPct || '30';
            document.getElementById('recoveryTimeYears').value = scenario.recoveryTimeYears || '3';
            
            // Update options visibility based on checkbox states
            const rothOptionsPanel = document.getElementById('rothRedirectOptions');
            if (rothOptionsPanel) {
                if (scenario.rothRedirectCheck) {
                    rothOptionsPanel.classList.remove('hidden');
                } else {
                    rothOptionsPanel.classList.add('hidden');
                }
            }
            
            const marketTimingOptionsPanel = document.getElementById('marketTimingOptions');
            if (marketTimingOptionsPanel) {
                if (scenario.marketTimingEnabled) {
                    marketTimingOptionsPanel.classList.remove('hidden');
                } else {
                    marketTimingOptionsPanel.classList.add('hidden');
                }
            }

            scenario.loans.forEach(loanData => {
                addLoan();
                const loanId = loans[loans.length - 1];
                document.getElementById(`${loanId}_purpose`).value = loanData.purpose;
                document.getElementById(`${loanId}_rate`).value = loanData.rate;
                document.getElementById(`${loanId}_balance`).value = loanData.balance;
                document.getElementById(`${loanId}_payment`).value = loanData.payment;
            });

            // Update UI based on loaded account type
            updateAccountTypeUI();
            updateCalculator();
            
            // Track the currently loaded scenario
            currentScenarioName = name;
            
            // Ensure Roth display is updated after scenario load
            setTimeout(() => {
                updateRothDisplay();
            }, 100);
        });

        // Missing helper functions
        function resetApp() {
            // Clear current scenario tracking
            currentScenarioName = null;
            const select = document.getElementById('scenarioSelect');
            if (select) select.value = '';
            
            document.getElementById('taxableIncome').value = '';
            document.getElementById('filingStatus').value = 'single';
            document.getElementById('accountType').value = 'traditional';
            document.getElementById('retirementBalance').value = '';
            document.getElementById('expectedReturn').value = '';
            document.getElementById('projectionYears').value = '10';
            document.getElementById('stateTaxRate').value = '';
            document.getElementById('applyStandardDeduction').checked = true;
            document.getElementById('itemizedDeduction').value = '';
            document.getElementById('age65Addl').value = 'none';
            document.getElementById('earlyPenaltyCheck').checked = false;
            document.getElementById('autoWithdrawCheck').checked = false;
            document.getElementById('rothRedirectCheck').checked = false;
            document.getElementById('rothRedirectSlider').value = 0;
            document.getElementById('rothTermRemaining').checked = false;
            document.getElementById('rothMaxRedirect').checked = true;
            document.getElementById('marketTimingEnabled').checked = false;
            document.getElementById('marketCorrectionPct').value = '30';
            document.getElementById('recoveryTimeYears').value = '3';
            document.getElementById('loansList').innerHTML = '';
            loans = [];
            loanCounter = 0;
            updateAccountTypeUI();
            updateMarketTimingUI();
            updateCalculator();
        }

        function loadSampleData() {
            document.getElementById('taxableIncome').value = '85000';
            document.getElementById('filingStatus').value = 'single';
            document.getElementById('retirementBalance').value = '150000';
            document.getElementById('expectedReturn').value = '7';
            document.getElementById('stateTaxRate').value = '5';
            document.getElementById('applyStandardDeduction').checked = true;
            document.getElementById('itemizedDeduction').value = '';
            document.getElementById('age65Addl').value = 'none';
            document.getElementById('earlyPenaltyCheck').checked = true;
            
            // Clear existing loans first
            document.getElementById('loansList').innerHTML = '';
            loans = [];
            loanCounter = 0;
            
            // Add sample loan
            addLoan(true); // prevent focus
            const loanId = loans[0];
            document.getElementById(`${loanId}_purpose`).value = 'Car Loan';
            document.getElementById(`${loanId}_rate`).value = '6.5';
            document.getElementById(`${loanId}_balance`).value = '19000';
            document.getElementById(`${loanId}_payment`).value = '380';
            
            updateCalculator();
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial focus on Annual Gross Income field
            const taxableIncome = document.getElementById('taxableIncome');
            if (taxableIncome) {
                setTimeout(() => taxableIncome.focus(), 100);
            }
            
            // Initialize account type UI
            updateAccountTypeUI();
            
            // Initialize market timing UI
            updateMarketTimingUI();
            
            // Load scenario dropdown
            loadScenarioList();
            
            // Show scenario loader if there are saved scenarios
            const scenarioLoader = document.getElementById('scenario-loader');
            if (Object.keys(localStorage).some(key => key.startsWith('scenario_'))) {
                scenarioLoader.classList.remove('hidden');
            }

            // Add event listeners for checkboxes
            const autoWithdrawCheck = document.getElementById('autoWithdrawCheck');
            if (autoWithdrawCheck) {
                autoWithdrawCheck.addEventListener('change', calculateResults);
            }

            const rothRedirectCheck = document.getElementById('rothRedirectCheck');
            if (rothRedirectCheck) {
                rothRedirectCheck.addEventListener('change', function() {
                    const rothOptionsPanel = document.getElementById('rothRedirectOptions');
                    if (rothOptionsPanel) {
                        if (this.checked) {
                            rothOptionsPanel.classList.remove('hidden');
                        } else {
                            rothOptionsPanel.classList.add('hidden');
                        }
                    }
                    calculateResults();
                });
            }

            const rothRedirectSlider = document.getElementById('rothRedirectSlider');
            if (rothRedirectSlider) {
                rothRedirectSlider.addEventListener('input', updateRothDisplay);
            }

            const rothTermRemaining = document.getElementById('rothTermRemaining');
            if (rothTermRemaining) {
                rothTermRemaining.addEventListener('change', calculateResults);
            }

            const rothMaxRedirect = document.getElementById('rothMaxRedirect');
            if (rothMaxRedirect) {
                rothMaxRedirect.addEventListener('change', calculateResults);
            }

            // Market timing event listeners
            const marketTimingEnabled = document.getElementById('marketTimingEnabled');
            if (marketTimingEnabled) {
                marketTimingEnabled.addEventListener('change', function() {
                    updateMarketTimingUI();
                    calculateResults();
                });
            }

            const marketCorrectionPct = document.getElementById('marketCorrectionPct');
            if (marketCorrectionPct) {
                marketCorrectionPct.addEventListener('input', calculateResults);
            }

            const recoveryTimeYears = document.getElementById('recoveryTimeYears');
            if (recoveryTimeYears) {
                recoveryTimeYears.addEventListener('input', calculateResults);
            }

            // Add event listeners for all input fields
            const inputs = ['taxableIncome', 'filingStatus', 'accountType', 'retirementBalance', 'expectedReturn', 'projectionYears', 'stateTaxRate', 'itemizedDeduction', 'age65Addl'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updateCalculator);
                    if (element.tagName === 'SELECT') {
                        element.addEventListener('change', updateCalculator);
                    }
                }
            });

            // Special handler for account type to update UI
            const accountTypeSelect = document.getElementById('accountType');
            if (accountTypeSelect) {
                accountTypeSelect.addEventListener('change', function() {
                    updateAccountTypeUI();
                    updateCalculator();
                });
            }

            const withdrawalSlider = document.getElementById('withdrawalSlider');
            if (withdrawalSlider) {
                withdrawalSlider.addEventListener('input', calculateResults);
            }

            const applyStandardDeduction = document.getElementById('applyStandardDeduction');
            if (applyStandardDeduction) {
                applyStandardDeduction.addEventListener('change', updateCalculator);
            }

            const earlyPenaltyCheck = document.getElementById('earlyPenaltyCheck');
            if (earlyPenaltyCheck) {
                earlyPenaltyCheck.addEventListener('change', calculateResults);
            }
        });

        // Initial load
        loadScenarioList();
    </script>
</body>
</html>